[TOC](目录)

# 高并发，负载均衡，高可用
## 高并发负载均衡
### TCP/IP五层模型
自上而下讲，TCP/IP五层模型分别为
第一层，应用层，在应用层中，我们将想要发送的数据包装成数据包，传输给下一层，这层的主要协议有Http，ssh等协议
第二层，传输控制层，这一层主要实现的功能是端点对端点通讯，这一层主要使用到的协议有TCP/IP协议，UDP协议
第三层，运输层，这一层主要的功能是通过目标地址的IP与路由表进行计算，获取下一跳所要跳向的IP地址的位置
第四层，数据链路层，这一层主要的功能是实现一个节点之间的通讯，通过ARP协议，我们可以将IP地址转换成对应的MAC地址，实现两台机器节点间的交互
第五层，物理层，主要用来运输处理好的数据，通俗讲就是光纤

#### TCP/IP协议和UDP协议
TCP/IP协议是一种建立连接的，可靠的传输协议
UDP协议是一种无连接的，不可靠的传输协议

#### TCP/IP为什么是建立连接的可靠的传输协议
因为TCP/IP协议规定了三次握手四次挥手

关于三次握手，就是当客户端A想与服务器B建立连接的时候，先向B发送一个连接请求，然后B确认收到，确认的同时向A发送一个信号，A再确认，确认信息到达B这，连接才真正的建立起来

三次握手完毕之后，连接建立，服务器和客户端才会开启资源分配，启动双方的线程

等到客户端不想再与服务器发生纠葛的时候，就要与服务器断开连接，此时就产生了四次挥手，四次挥手的过程就是客户端A向服务器B发送一个断开连接的请求，服务器确认，但是不会立刻断开连接，有可能服务器还有部分数据想要传给客户端，等到服务器也不想与客户端进行通讯的时候，服务器也会发送断开连接的请求，客户端进行确认之后，双方才会断开连接，这就是四次挥手

正是因为这些规定，保证了数据传输的完整性和安全性

#### 运输层怎么去获取下一跳
通过IP与路由表中的子网掩码进行与运算，算出的结果与目标地址相同的情况下，就能找到对应的网关（下一跳的IP地址），0.0.0.0代表处于同一局域网之中

#### 什么是ARP协议
ARP协议是用来将IP地址转化为MAC地址的
就是当获取一个网关IP地址后，他发送一个包含目标IP，源IP，目标MAC，源MAC地址的报文出去，通过路由广播给网络内所有的成员，然后每个成员都接受并处理这个报文，如果目标地址是自己的IP，就把目标MAC地址发回去

### 负载均衡模型

#### NAT
NAT翻译为网络地址转换，默认的NAT是指将内部IP转换成公网IP，并替换端口号，这种称为源NAT
还有一种NAT是D-NAT（目标NAT），就是指将公网IP转化为内部IP

#### 四层负载均衡的优缺点
优点：速度快，不经过握手过程
缺点：相对于Nginx这种应用层软件，四层负载均衡只能够进行一些简单的路由，所以要求服务器端必须都是镜像

#### DNAT模型
客户端向服务器发送数据，但是数据实际上先发送到了四层负载均衡那边，然后通过D-NAT进行一个IP地址的转换,将IP转换成真正服务器所在的IP地址，然后通过ARP找到对应的MAC地址，将数据传输过去，返回的时候要沿原路返回

不足之处：他进来回去都要经过负载均衡服务器，而回去的时候，所带数据较多，会造成带宽不够的问题，达到一个性能瓶颈。回去的时候还要进行IP地址的转化，消耗算力，返回的时候要求真正服务器的默认网关指向负载均衡服务器地址

#### DR模型
直接路由模型：是基于数据链路层上数据的修改，负载均衡服务器接收到数据包后，通过修改下一跳的MAC地址来达到MAC地址欺骗的效果，下一跳就会跳到我真正的服务器，为了接受这个数据包，必须在服务器上建立一个与负载均衡服务器相同的IP地址，这个地址只对内部可见，然后服务器处理完毕之后，就直接将数据返回给用户，不再需要通过负载均衡服务器了

优劣：解决了DNAT模型上带宽不足的问题，基于第二层进行修改，消耗更低，速度更快，返回的时候不经过负载均衡服务器，直接通过真正的服务器进行返回，减少了负载均衡服务器的压力，节约成本，缺点是由于这是基于下一跳的修改，所以真正的服务器必须与负载均衡服务器在同一局域网

#### TUN模型
隧道模型，主要做的工作是将客户端发送到负载均衡服务器的数据包进行再封装一层运输层，让这个运输层指向RS，RS收到之后拆包处理成真正发送的数据包，并且RS上也有对内可见，对外不可见的VIP，所以能够正常处理和发回。

优劣：这个模型综合了DR和DNAT模型，放弃了部分性能，但弥补了DR模型的最大的缺陷，他能够让负载均衡服务器与RS可以不在同一网段中，更加的灵活。但是速度没DR模型快速

### 四层负载均衡实现
#### LVS技术
使用Linux内核中集成的ipvs模块实现四层负载均衡

## 高可用
### keepalived
使用keepalived实现负载均衡服务器的高可用
使用的实现模式是主备模式
keepalived会监控当前主负载均衡服务器是否可用，并定期向外部发送广播，备用负载均衡服务器会接收这个信息，如果一段时间内无法接受到，那么备用服务器就会去检查主服务器状态，如果发现主服务器宕机，备用服务器就会根据权重推举一台备用服务器做负载均衡的工作，这一切对客户端都是透明的
keepalived在还会时刻监测RS的健康状态，如果发现无法连接到RS（即发送应用层请求没有返回信息），那么就会将宕机的RS从RS列表中剔除
keepalived同时监测自己的服务状态
keepalived还会帮助创建vip监测，启动负载均衡服务