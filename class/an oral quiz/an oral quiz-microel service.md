# WRMS(Waste and Resource
Management System)微服务架构

总:WRMS是新加坡政府的一个废物和资源管理系统,主要分为几大块WMS(可循环利用的垃圾回收提交服务),E-Tracking(有毒废弃物的追踪服务),E-Pstles(用于规划电力和可再生资源的),iWMS(与其他平台交互,整合运输信息和收付款的),SSEA(电器销售调查),NSS(提供一个定制化的调查问卷功能)这些模块

分:

我们的BE用户主要是新加坡那边的公务员,FE用户主要是一些公民和公司,然后当时的架构是架构师设计的,主要架构内容如下

1.从客户端开始说吧,我们设置了cdn加速服务器,这个是上线之后设置的,当然由于我们的受众问题,自然并发不是很高,所以并不是因为服务器承受不住压力才加的,是运行了一段时间之后发现由于静态资源产生了高额带宽费,所以才需要加入cdn服务器的

2.然后就是用nginx做反向代理,负载均衡

3.然后网关层,使用Spring Gateway进行鉴权

4.然后就是具体的微服务了,服务注册中心用的eureka

5.微服务之间的相互通讯使用的是restTemplate,负载均衡使用的是ribbon,然后熔断降级用的是hystrix(@HystrixCommand注解)

6.消息中间件选用RabbitMQ(RocketMQ)（为什么要用MQ,因为BE,FE是两批用户，存储的时候允许数据非实时一致，只需要最终一致，所以为了加速响应速度，使用MQ做异步处理，还可以保证数据不丢失）

7.服务链路追踪通过sleuth和zipkin,配合

8.服务监控通过Spring Admin,上报通过actuator

9.配置中心没有,因为我们的服务不需要开很多node,就开了三个,只是为了解决单点故障问题的,没有那么高的并发(也可以说用了,反正spring cloud的config-server也不影响具体使用和操作,不过有个小坑,这边要说自己用的配置文件是bootstrap.yaml去加载的配置中心地址,如果是application.yaml就露馅了,因为bootstrap比application早读取,只有通过这种方式才能通过读取bootstrap文件知道配置中心位置,一旦读到application了,可能就会由于丢失某些先行配置报错了)

10.项目使用ubantu上的docker进行部署

11.马上要上亚马逊云,之前一直用的自己的服务器

(12.没有做中台,其实我觉得对于文件系统,用户登陆这些点我们还是可以做中台的,毕竟很多项目组都用到了,当然为了追求新技术,可能做中台也不是非常划算,所以就没做)

13.项目的关系型数据库用的mysql，内存型数据库用的redis

# 微服务网关的作用

总:鉴权,限流,黑白名单,路由转发(还有好多)

分:

鉴权就是根据进来的url看看当前访问的url是否需要什么权限,是否要登陆才能访问等

限流是指整体的限流(使用过滤器)(延申单个服务的限流(AOP,过滤器))

黑白名单对外部接入的系统进行限制(用oauth2或jwt + redis)

路由转发

## 三方交互

用oauth2或jwt + redis

1.客户端login,请求发到服务器,服务器认证并发回两个token,一个是access_token一个是ref_token,其中ref_token用于access_token过期后平滑过渡,刷新,所以过期时间要设置长一点,一旦access_token过期,就用ref_token作为令牌进行请求,去刷新access_token的时间

# 解释一下什么是中台

随着服务的堆积,通用服务沉淀,让开发新业务时提高效率

比如经常做的用户信息管理服务,文件系统

主要是为了减少重复开发,松散耦合

# 多数据库下如何关联查询?如何做报表?

用业务逻辑去查

对于不同数据库下的报表,可以使用阿里的canal去做,把数据进行总汇,做成报表（这里说的是mysql，canal是以伪装成一台mysql的slave，然后让mysql同步增量的binlog的方式，获取数据并处理的）

# 注册中心挂了,服务还能访问吗?

如果是单机,那么注册中心挂了,当前微服务还存在其他服务的缓存url,那么就可以,如果没有其他服务的url,当然不可以

如果注册中心已经做了集群,那么挂一台没啥大关系,总是可以

# Eureka集群之间如何通讯

eureka集群有两种模式,一种是类似于无状态模式的,每个客户端上线都发送给全部eureka服务器信息,并建立链接发送心跳,对于这种集群,不通讯,第二种,集群间互相感知,传输数据,通过HTTP协议进行通讯

# Eureka服务器与客户端通讯

客户端每隔30秒都会去服务器拉取新的数据并发送心跳,同时更新本地缓存列表(默认90s缓存过期)

拉取的时候可以全量拉取,也可以增量拉取

# 配置中心的作用

配置中心主要是用于多个服务的一键配置,动态更新,灰度发布,微服务改配置文件之后要改动很多服务器,太累,所以需要配置中心,配置中心有spring cloud的config server,nacos,apollo,可以配合github的钩子实现一个响应式的配置文件更新

## 什么是灰度(金丝雀)发布

就是发布的时候不同步发布,某些用户可能用的老版本,另一些用的新的

# 熔断,降级

熔断是指多次调用服务,服务未响应,或者出现错误,打开熔断开关,下次请求到达时不访问提供者,直接返回备用方案,开关打开后,过段时间(30s)变成半开状态,放过一个请求到达后端,如果成功,关闭熔断

降级就是指出现错误的时候,比如网络问题,提供者异常等,就进行备用方案返回

